<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拣货详情</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .main-fixed {
            width: 400px;
            height: 665px;
            margin: 0 auto;
            background: #f5f5f5;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 防止容器滚动 */
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0 8px 0;
            position: relative;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .back-button {
            position: absolute;
            left: 9px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            border-radius: 0;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #333;
            cursor: pointer;
        }
        .header-title {
            font-size: 22px;
            font-weight: bold;
            color: #222;
            margin: 0 auto;
            text-align: center;
            flex: 1;
        }
        .terminate-btn {
            position: absolute;
            right: 9px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.2s;
        }
        .terminate-btn:hover:not(:disabled) {
            color: #333;
        }
        .terminate-btn:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        .scan-area {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 18px 18px 10px 18px;
            margin-bottom: 6px;
            box-sizing: border-box;
        }
        .scan-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .scan-input-wrapper img {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
            width: 30px;
            height: 30px;
        }
        .scan-input {
            width: 100%;
            box-sizing: border-box;
            padding: 14px 40px 14px 40px;
            font-size: 16px;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            background: #fff;
            outline: none;
            margin-bottom: 2px;
        }
        .scan-input:focus {
            border: 1.5px solid #3a8bfd;
            background: #f0f7ff;
        }
        .info-area {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 10px 8px 10px 8px;
            margin-bottom: 5px;
            display: flex;
            flex-direction: row;
            font-size: 17px;
            gap: 0;
            justify-content: space-between;
        }
        .info-col-left {
            flex: 1 1 60%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .info-col-right {
            flex: 1 1 40%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            justify-content: flex-start;
        }
        .info-row {
            display: flex;
            align-items: center;
            min-height: 22px;
        }
        .info-label {
            color: #888;
            margin-right: 4px;
        }
        .info-value {
            color: #222;
            font-weight: bold;
        }
        .info-highlight {
            color: #0099ff;
            font-size: 15px;
            font-weight: bold;
            margin: 0 2px;
        }
        .pending-list-area {
            background: none;
            border-radius: 10px;
            padding: 0px 0 0px 0;
            margin: 0px 0px 0px 0px;
            flex: 1;
            overflow-y: auto; /* 允许列表区域滚动 */
            position: relative;
        }
        .pending-list-title {
            font-size: 18px;
            font-weight: bold;
            color: #222;
            padding: 12px 8px 8px 8px;
            display: block;
        }
        .pending-list {
            width: 100%;
            padding-bottom: 20px;
        }
        .location-group {
            background: #fff;
            border-radius: 4px;
            margin-bottom: 8px;
            overflow: hidden;
            border: 1px solid #dddddd;
        }
        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 9px;
            background: #eeeeee;
            cursor: pointer;
            border-bottom: 1px solid #dddddd;
            border-radius: 4px 4px 0 0;
        }
        .location-header.collapsed {
            border-bottom: none;
            border-radius: 4px;
        }
        .location-name {
            font-size: 16px;
            color: #333333;
            font-weight: bold;
        }
        .location-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        .location-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .location-items {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            background-color: #fff;
        }
        .location-items.collapsed {
            max-height: 0;
        }
        .pending-item {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            border-bottom: 2px solid #acacac;
            padding: 0px 8px 4px 8px;
            position: relative;
            margin-bottom: 0px;
            background: #fff;
        }
        .pending-item:last-child {
            border-bottom: none;
        }
        
        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-top: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #acacac;
            width: 100%;
            background-color: #fff;
        }
        .pending-location {
            font-size: 16px;
            color: #222;
        }
        .pending-fnsku-wrapper {
            display: flex;
            align-items: center;
            gap: 0px;
            width: 100%;
            justify-content: flex-end;
        }
        .pending-sku-display {
            font-size: 15px;
            color: #222;
            font-weight: bold;
            margin-right: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
            margin-right: auto;
        }
        .pending-check-btn {
            width: 20px;
            height: 20px;
            border: 1.5px solid #1677ff;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
        }
        .pending-check-btn.checked {
            background: #1677ff;
        }
        .pending-check-btn.checked::after {
            content: '';
            width: 12px;
            height: 6px;
            border-left: 2px solid #fff;
            border-bottom: 2px solid #fff;
            transform: rotate(-45deg) translate(1px, -1px);
        }
        .pending-check-btn.partial {
            background: #1677ff;
        }
        .pending-check-btn.partial::after {
            content: '';
            width: 10px;
            height: 2px;
            background-color: #fff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .pending-check-btn:hover {
            border-color: #125fd1;
        }
        .pending-check-btn.checked:hover {
            background: #125fd1;
        }
        .pending-content {
            display: flex;
            align-items: flex-start;
            margin-top: 6px;
        }
        .pending-img-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 12px;
            flex-shrink: 0;
            width: 60px;
        }
        .pending-img {
            width: 60px;
            height: 60px;
            background: #ededed;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            margin-top: -7px; /* 向上移动7px */
        }
        .pending-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            display: block;
        }
        .pending-fnsku {
            font-size: 12px;
            color: #888;
            word-break: break-all;
            text-align: center;
        }
        .pending-info-main {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .pending-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
            margin-right: 10px;
            
        }
        .pending-row {
            font-size: 15px;
            color: #333;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            
        }
        .pending-row .label {
            color: #666;
            margin-right: 4px;
        }
        .pending-sku {
            font-size: 15px;
            color: #333;
            word-break: break-all;
        }
        .pending-count-area {
            flex-shrink: 0;
            width: 110px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: -7px; /* 向上移动7px */
        }
        .pending-count-label {
            color: #444;
            font-size: 15px;
            margin-bottom: 4px;
            line-height: 1.1;
        }
        .pending-count-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f6f6f6;
            border-radius: 10px;
            padding: 8px 4px;
            min-width: 110px;
            max-width: 130px;
            height: 75px;
            text-align: center;
        }
        .pending-count-row {
            white-space: nowrap;
            padding: 0 6px;
        }
        .pending-count-input {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 18px;
            color: #00aaff;
            font-weight: bold;
            margin-right: 2px;
            box-sizing: border-box;
        }
        .pending-count-input::-webkit-outer-spin-button,
        .pending-count-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .pending-count-input:focus {
            border-color: #1677ff;
            outline: none;
        }
        .pending-total {
            color: #222;
            font-size: 18px;
            font-weight: bold;
        }
        .footer-btn-area {
            background: none;
            padding: 16px 0 12px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: auto; /* 确保按钮区域在底部 */
            position: relative;
            z-index: 1;
        }
        .footer-btn {
            width: 180px;
            padding: 14px 0;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #1677ff;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(22,119,255,0.08);
            transition: all 0.2s;
        }
        .footer-btn:disabled {
            background: #a0cfff;
            cursor: not-allowed;
            box-shadow: none;
        }
        .footer-btn:active:not(:disabled) {
            background: #125fd1;
        }
        .footer-btn-clear {
            background-color: #ea4335;
            color: #fff;
        }
        .footer-btn-clear:disabled {
            background-color: #ffb3b3;
            cursor: not-allowed;
            box-shadow: none;
        }
        .footer-btn-clear:active:not(:disabled) {
            background-color: #c0392b;
        }
        .pending-item.checked-highlight {
            background-color: #e8f0fe; /* Light blue background */
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .custom-modal-container {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .custom-modal-overlay.visible .custom-modal-container {
             transform: scale(1);
        }
        .custom-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .custom-modal-body {
            font-size: 17px;
            color: #555;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .custom-modal-footer {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .custom-modal-button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex: 1;
        }
        .custom-modal-button-confirm {
            background: #1677ff;
            color: #fff;
        }
        .custom-modal-button-confirm:hover {
            background: #125fd1;
        }
        .custom-modal-button-cancel {
            background: #eee;
            color: #333;
        }
         .custom-modal-button-cancel:hover {
            background: #ddd;
        }

        /* Custom Alert Styles */
         .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-alert-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .custom-alert-container {
            background: #333;
            padding: 32px 36px 24px 36px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 180px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .custom-alert-overlay.visible .custom-alert-container {
            transform: scale(1);
        }
        .custom-alert-icon {
            width: 64px;
            height: 64px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 18px;
        }
        .custom-alert-icon span {
            font-size: 38px;
            color: #333;
            font-weight: bold;
        }
        .custom-alert-text {
            color: #fff;
            font-size: 22px;
            text-align: center;
        }

        /* 成功提示样式 */
        .custom-success-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.0); /* Transparent background */
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            z-index: 10001;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-success-alert-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .custom-success-alert-container {
            background: #424242;
            color: #fff;
            padding: 32px 36px 24px 36px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 16px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 180px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .custom-success-alert-overlay.visible .custom-success-alert-container {
            transform: scale(1);
        }

        /* Tooltip Styles */
        .tooltip-container {
            position: fixed;
            top: 12px;
            right: calc(50% - 400px / 2 + 9px + 100px);
            display: inline-block;
            vertical-align: middle;
            z-index: 1001;
        }

        .info-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 6px;
            background-color: #ffe066;
            color: #b48a00;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ffd700;
        }

        .tooltip-content {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 260px;
            max-width: 340px;
            background-color: #ffe066;
            color: #222;
            padding: 16px 18px 12px 18px;
            border-radius: 8px;
            white-space: pre-line;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }


    </style>
</head>
<body>
    <div class="main-fixed">
        <div class="container">
            <div class="header">
                <button class="back-button" onclick="window.location.href='warehouse_picking_list.html'">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.5 19L9.5 12L15.5 5" stroke="#222" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="header-title">扫码拣货</span>
                <button class="terminate-btn" id="terminateBtn" disabled>终止拣货</button>
            </div>
            <div class="tooltip-container">
                <span class="info-icon">!</span>
                <div class="tooltip-content">本原型的待拣货数量需要关闭页面重开才能恢复
                    <br>
                    箱码：CD250423000001、CD250423000002、CD250423000003
                    条码：X002LCPX、X00302LCPX、X6SV4S4Y
                </div>
            </div>
            <div class="scan-area">
                <div class="scan-input-wrapper">
                    <img src="icon/screenshot_2025-05-22_16-58-53.png" alt="扫描条码">
                    <input type="text" class="scan-input" id="scanInput" placeholder="扫描箱码/条码" />
                </div>
            </div>
            <div class="info-area">
                <div class="info-col-left">
                    <div class="info-row"><span class="info-label">拣货单号：</span><span class="info-value" id="pickingCode">PJ20250524001</span></div>                    
                    <div class="info-row" style="display: none;"><span class="info-label">发货单号：</span><span class="info-value" id="shippingCode">OP20250524001</span></div>
                    <div class="info-row">
                        <span class="info-label">已选/待拣/总数 :</span>
                        <span class="info-value" id="pickingQuantities">0 / 0 / 100</span>
                    </div>
                </div>
            </div>
            <div class="pending-list-area">
                
                <div class="pending-list" id="pendingList">
                    <!-- 列表项由JS渲染 -->
                </div>
            </div>
        </div>
        <div class="footer-btn-area">
            <button class="footer-btn footer-btn-clear" id="footerClearBtn" disabled>清空选择</button>
            <button class="footer-btn" id="footerConfirmBtn" disabled>确认拣货</button>
        </div>
    </div>

    <!-- 二次确认弹窗 -->
    <div class="custom-modal-overlay" id="confirmPickingModalOverlay">
        <div class="custom-modal-container">
            <div class="custom-modal-title">确认拣货</div>
            <div class="custom-modal-body">
                已选/待拣/总数 : <span id="modalPickingQuantities"></span>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-button custom-modal-button-cancel" id="modalCancelBtn">取消</button>
                <button class="custom-modal-button custom-modal-button-confirm" id="modalConfirmBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- 提示弹窗 -->
    <div class="custom-alert-overlay" id="customAlertModalOverlay">
        <div class="custom-alert-container" id="customAlertModalContent">
            <!-- Alert message goes here -->
        </div>
    </div>

    <!-- 成功提示弹窗 -->
    <div class="custom-success-alert-overlay" id="customSuccessAlertOverlay">
        <div class="custom-success-alert-container" id="customSuccessAlertContent">
            <!-- Success message goes here -->
        </div>
    </div>

    <!-- 终止拣货确认弹窗 -->
    <div class="custom-modal-overlay" id="terminateModalOverlay">
        <div class="custom-modal-container">
            <div class="custom-modal-title">终止拣货</div>
            <div class="custom-modal-body">
                有<span id="terminatePendingCount">0</span>待拣，是否确定终止拣货
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-button custom-modal-button-cancel" id="terminateCancelBtn">取消</button>
                <button class="custom-modal-button custom-modal-button-confirm" id="terminateConfirmBtn">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 获取URL参数
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        const pickingCode = getQueryParam('picking_code') || 'PJ20250524001';
        
        // 模拟数据
        const detailData = {
            'PJ20250524001': {
                pickingCode: 'PJ20250524001',
                shippingCode: 'OP20250524001',
                totalCount: 100,
                currentPickingCount: 0
            }
        };

        // 从sessionStorage获取已确认的拣货数量
        function getConfirmedCounts() {
            const confirmedCountsStr = sessionStorage.getItem(`confirmedCounts_${pickingCode}`);
            return confirmedCountsStr ? JSON.parse(confirmedCountsStr) : {};
        }

        // 保存已确认的拣货数量到sessionStorage
        function saveConfirmedCounts(confirmedCounts) {
            sessionStorage.setItem(`confirmedCounts_${pickingCode}`, JSON.stringify(confirmedCounts));
        }

        // 模拟待拣货数据
        const pendingData = [
            {
                location: 'KW20250524001',
                location_name:'库位1',
                fnsku: 'X00302LCPX',
                sku: 'ST210628UBCOGNAC100',
                img: 'icon/3.png',
                spu: 'ST210628UB',
                color_size: '栗色/10',
                num: 30,
                current: 0
            },
            {
                location: 'KW20250524001',
                location_name:'库位1',
                fnsku: 'X6SV4S4Y',
                sku: 'ST210628UBBLACK9',
                img: 'icon/3.png',
                spu: 'ST210628UB',
                color_size: '黑色/9',
                num: 15,
                current: 0
            },
            {
                location: 'KW20250524002',
                location_name:'库位2',
                fnsku: 'X6SV4S4Y',
                sku: 'ST210628UBBLACK9',
                img: 'icon/3.png',
                spu: 'ST210628UB',
                color_size: '黑色/9',
                num: 55,
                current: 0
            }
        ];

        // 初始化时从sessionStorage加载已确认的数量
        const confirmedCounts = getConfirmedCounts();
        pendingData.forEach(item => {
            if (confirmedCounts[item.sku]) {
                // 减去已确认的数量来得到真实的待拣货数量
                item.num -= confirmedCounts[item.sku];
            }
        });

        // 存储已扫描的箱码
        const scannedBoxCodes = new Set();

        // 模拟箱码数据（实际应该从后端获取）
        const boxData = {
            'CD250423000001': {
                skus: ['ST210628UBCOGNAC100', 'ST210628UBBLACK9'],
                quantities: [15, 35]
            },
            'CD250423000002': {
                skus: ['ST210628UBCOGNAC100', 'ST210628UBBLACK9'],
                quantities: [15, 35]
            },
            'CD250423000003': {
                skus: ['ST210628UBCOGNAC090', 'ST210628UBBLACK100'],
                quantities: [15, 35]
            }
        };

        // 校验箱码
        function validateBoxCode(boxCode) {
            // 1. 检查是否重复扫描
            if (scannedBoxCodes.has(boxCode)) {
                showCustomAlert('重复扫描');
                return false;
            }

            // 2. 检查箱码是否存在
            if (!boxData[boxCode]) {
                showCustomAlert('无效箱码');
                return false;
            }

            // 3. 检查箱内SKU是否属于当前拣货单
            const boxSkus = boxData[boxCode].skus;
            const boxQuantities = boxData[boxCode].quantities;
            
            for (let i = 0; i < boxSkus.length; i++) {
                const sku = boxSkus[i];
                const quantity = boxQuantities[i];
                
                // 查找SKU在待拣货列表中的位置
                const pendingItem = pendingData.find(item => item.sku === sku);
                
                if (!pendingItem) {
                    showCustomAlert('货品错误');
                    return false;
                }

                // 4. 检查数量是否超出待拣货数
                if (pendingItem.current + quantity > pendingItem.num) {
                    showCustomAlert('货品数量超出');
                    return false;
                }
            }

            // 校验通过，记录箱码并更新数量
            scannedBoxCodes.add(boxCode);
            for (let i = 0; i < boxSkus.length; i++) {
                const sku = boxSkus[i];
                const quantity = boxQuantities[i];
                const pendingItem = pendingData.find(item => item.sku === sku);
                pendingItem.current += quantity;
            }

            return true;
        }

        // 校验条码
        function validateBarcode(barcode) {
            // 1. 检查条码是否属于当前拣货单
            const pendingItem = pendingData.find(item => item.fnsku === barcode);
            if (!pendingItem) {
                showCustomAlert('货品错误');
                return false;
            }

            // 2. 检查数量是否超出待拣货数
            if (pendingItem.current + 1 > pendingItem.num) {
                showCustomAlert('货品数量超出');
                return false;
            }

            // 校验通过，更新数量
            pendingItem.current += 1;
            return true;
        }

        // 更新信息区域显示
        function updateInfoArea() {
            // 计算当前总拣货数量 (current session)
            const currentPickedInSession = pendingData.reduce((sum, item) => sum + item.current, 0);
            // 计算列表中剩余待拣数量总和
            const remainingToPickInList = pendingData.reduce((sum, item) => sum + item.num, 0);
            
            const totalPlannedCount = detailData[pickingCode].totalCount;
            // const pendingToPickCount = totalPlannedCount - currentPickingCount; // Original calculation

            // Update the single quantity display
            // Display format: 已选/待拣/总数
            document.getElementById('pickingQuantities').innerHTML = 
                `${currentPickedInSession} / <span style="color: #222;">${remainingToPickInList}</span> / ${totalPlannedCount}`;

            const footerClearBtn = document.getElementById('footerClearBtn');
            const footerConfirmBtn = document.getElementById('footerConfirmBtn');
            const terminateBtn = document.getElementById('terminateBtn');

            // 更新按钮状态 based on current picked count in session
            if (currentPickedInSession > 0) {
                footerClearBtn.disabled = false;
                footerConfirmBtn.disabled = false;
            } else {
                footerClearBtn.disabled = true;
                footerConfirmBtn.disabled = true;
            }

            // 终止拣货按钮状态：待拣数量等于总数或等于0时禁用
            // Now using remainingToPickInList for the condition
            terminateBtn.disabled = (remainingToPickInList === totalPlannedCount);
        }

        // 渲染待拣货列表
        function renderPendingList() {
            const list = document.getElementById('pendingList');
            
            // 按库位分组
            const groupedByLocation = {};
            pendingData.forEach(item => {
                if (item.num <= 0) return;
                
                if (!groupedByLocation[item.location]) {
                    groupedByLocation[item.location] = {
                        location: item.location,
                        location_name: item.location_name,
                        items: []
                    };
                }
                groupedByLocation[item.location].items.push(item);
            });

            // 渲染分组后的列表
            list.innerHTML = Object.values(groupedByLocation).map((group, groupIndex) => `
                <div class="location-group" data-location="${group.location}">
                    <div class="location-header" onclick="toggleLocation('${group.location}')">
                        <div class="location-name"><span style="color: #666666; font-weight: normal; margin-right: 4px;">库位:</span>${group.location_name}</div>
                        <div class="location-toggle">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                                <path d="M6 9L12 15L18 9" stroke="#666666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="location-items">
                        ${group.items.map((item, index) => `
                            <div class="pending-item ${item.current === item.num ? 'checked-highlight' : ''}">
                                <div class="pending-header">
                                    <div class="pending-fnsku-wrapper">
                                        <div class="pending-sku-display">${item.sku}</div>
                                        <button class="pending-check-btn ${item.current === item.num ? 'checked' : (item.current > 0 ? 'partial' : '')}" 
                                            onclick="checkAll('${group.location}', ${index})"></button>
                                    </div>
                                </div>
                                <div class="pending-content">
                                    <div class="pending-img-area">
                                        <div class="pending-img">
                                            <img src="${item.img}" alt="产品图片" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">
                                        </div>
                                    </div>
                                    <div class="pending-info-main">
                                                                            <div class="pending-info">
                                        <div class="pending-row"><span class="label">货号：</span>${item.spu}</div>
                                        <div class="pending-row"><span class="label">颜色/尺码：</span>${item.color_size}</div>
                                        <div class="pending-row"><span class="label">条码：</span>${item.fnsku}</div>
                                    </div>
                                        <div class="pending-count-area">
                                            <div class="pending-count-box">
                                                <div class="pending-count-label">已选/待拣</div>
                                                <div class="pending-count-row">
                                                    <input type="number" class="pending-count-input" value="${item.current}" 
                                                        onchange="updateItemCount('${group.location}', ${index}, this.value)" min="0" max="${item.num}">
                                                    <span style="color:#222;font-weight:bold;">/</span>
                                                    <span class="pending-total">${item.num}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // 初始化所有库位为展开状态
            Object.keys(groupedByLocation).forEach(location => {
                const header = list.querySelector(`[data-location="${location}"] .location-header`);
                const items = list.querySelector(`[data-location="${location}"] .location-items`);
                if (header && items) {
                    header.classList.remove('collapsed');
                    items.classList.remove('collapsed');
                }
            });
        }

        // 添加展开/收起功能
        function toggleLocation(location) {
            const group = document.querySelector(`[data-location="${location}"]`);
            if (!group) return;

            const header = group.querySelector('.location-header');
            const items = group.querySelector('.location-items');
            const toggle = group.querySelector('.location-toggle');

            header.classList.toggle('collapsed');
            items.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // 修改checkAll函数
        function checkAll(location, index) {
            const group = pendingData.filter(item => item.location === location);
            const item = group[index];
            if (!item) return;

            // 如果当前是部分勾选或未勾选状态，则设为全选
            // 如果当前是全选状态，则设为未勾选
            if (item.current === item.num) {
                item.current = 0;
            } else {
                item.current = item.num;
            }

            // 获取对应的勾选按钮并更新样式
            const locationGroup = document.querySelector(`[data-location="${location}"]`);
            if (locationGroup) {
                const items = locationGroup.querySelectorAll('.pending-item');
                if (items[index]) {
                    const checkBtn = items[index].querySelector('.pending-check-btn');
                    if (checkBtn) {
                        checkBtn.classList.remove('checked', 'partial');
                        if (item.current === item.num) {
                            checkBtn.classList.add('checked');
                        } else if (item.current > 0) {
                            checkBtn.classList.add('partial');
                        }
                    }
                }
            }

            updateInfoArea();
            renderPendingList();
        }

        // 修改updateItemCount函数
        function updateItemCount(location, index, value) {
            const group = pendingData.filter(item => item.location === location);
            const item = group[index];
            if (!item) return;

            const num = parseInt(value) || 0;
            const max = item.num;
            item.current = Math.min(Math.max(0, num), max);
            
            // 获取对应的勾选按钮并更新样式
            const locationGroup = document.querySelector(`[data-location="${location}"]`);
            if (locationGroup) {
                const items = locationGroup.querySelectorAll('.pending-item');
                if (items[index]) {
                    const checkBtn = items[index].querySelector('.pending-check-btn');
                    if (checkBtn) {
                        checkBtn.classList.remove('checked', 'partial');
                        if (item.current === item.num) {
                            checkBtn.classList.add('checked');
                        } else if (item.current > 0) {
                            checkBtn.classList.add('partial');
                        }
                    }
                }
            }
            
            updateInfoArea();
            renderPendingList();
        }

        // 扫描输入框逻辑
        const scanInput = document.querySelector('.scan-input');
        scanInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const code = this.value.trim();
                if (!code) return;
                
                console.log('扫描输入:', code);
                
                try {
                    // 根据前两位判断是箱码还是条码
                    if (code.startsWith('CD')) {
                        const valid = validateBoxCode(code);
                        console.log('箱码校验结果:', valid);
                        if (valid) {
                            updateInfoArea();
                            renderPendingList();
                        }
                    } else {
                        const valid = validateBarcode(code);
                        console.log('条码校验结果:', valid);
                        if (valid) {
                            updateInfoArea();
                            renderPendingList();
                        }
                    }
                } catch (error) {
                    console.error('处理扫描输入时出错:', error);
                } finally {
                    // 无论发生什么情况，都确保清空输入框
                    console.log('清空输入框');
                    setTimeout(() => {
                        this.value = '';
                        scanInput.value = '';
                        document.getElementById('scanInput').value = '';
                    }, 10);
                }
            }
        });

        // 额外确保输入框获得焦点时会清空
        scanInput.addEventListener('focus', function() {
            this.value = '';
        });

        // 清空按钮点击事件
        const footerClearBtn = document.getElementById('footerClearBtn');
        footerClearBtn.onclick = function() {
            // 重置所有商品的当前拣货数量
            pendingData.forEach(item => {
                item.current = 0;
            });
            updateInfoArea();
            renderPendingList();
        };

        // 底部确认按钮点击事件
        const footerConfirmBtn = document.getElementById('footerConfirmBtn');
        const confirmPickingModalOverlay = document.getElementById('confirmPickingModalOverlay');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalPickingQuantitiesSpan = document.getElementById('modalPickingQuantities'); // Get the span for quantities in the modal

        footerConfirmBtn.onclick = function() {
            // Calculate quantities based on the current state of pendingData
            const currentPickedInSession = pendingData.reduce((sum, item) => sum + item.current, 0);
            const remainingToPickInList = pendingData.reduce((sum, item) => sum + item.num, 0);
            const totalPlannedCount = detailData[pickingCode].totalCount;

            // Update the modal body content with current session picked, remaining pending, and total planned
            // Display format: 已选 / 待拣 / 总数
            // The '待拣' quantity should reflect remaining items in the list
            modalPickingQuantitiesSpan.innerHTML = 
                `${currentPickedInSession} / ${remainingToPickInList} / ${totalPlannedCount}`;
            
            // Show modal
            confirmPickingModalOverlay.classList.add('visible');
        };

        // Modal Cancel button click event
        modalCancelBtn.onclick = function() {
            confirmPickingModalOverlay.classList.remove('visible');
        };

        // Modal Confirm button click event
        modalConfirmBtn.onclick = function() {
            // Hide confirmation modal
            confirmPickingModalOverlay.classList.remove('visible');

            // 保存当前拣货数量到sessionStorage
            const currentConfirmedCounts = getConfirmedCounts(); // Get existing confirmed counts
            let totalPickedThisSession = 0; // Track total picked in this session for the calculation
            pendingData.forEach(item => {
                if (item.current > 0) {
                    // Add newly picked quantity to existing confirmed quantity for this SKU
                    currentConfirmedCounts[item.sku] = (currentConfirmedCounts[item.sku] || 0) + item.current;
                    totalPickedThisSession += item.current; // Add to session total
                }
            });
            saveConfirmedCounts(currentConfirmedCounts);

            // 使用success类型的提示
            showCustomAlert('拣货成功', 'success');

            // Calculate remaining quantity after this confirmation
            const totalPlannedCount = detailData[pickingCode].totalCount;
            const totalConfirmedAfterThis = Object.values(currentConfirmedCounts).reduce((sum, count) => sum + count, 0);
            const remainingAfterThis = totalPlannedCount - totalConfirmedAfterThis;

            // If remaining is 0, go back to list page; otherwise, reload page
                setTimeout(() => {
                if (remainingAfterThis <= 0) {
                    window.location.href = 'warehouse_picking_list.html'; // Navigate to list page
            } else {
                    window.location.reload(); // Reload current page
                }
            }, 1500); // Wait for 1.5 seconds before action
        };

        // Custom Alert function
        let alertTimeout;
        function showCustomAlert(message, type = 'error', duration = 1500) {
            if (type === 'success') {
                // 使用成功提示样式
                const alertOverlay = document.getElementById('customSuccessAlertOverlay');
                const alertContent = document.getElementById('customSuccessAlertContent');
                
                // Add checkmark icon and text
                alertContent.innerHTML = `
                    <div class="custom-alert-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="38" height="38">
                            <path d="M5 13L9 17L19 7" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="custom-alert-text" style="color: #fff; font-size: 22px;">${message}</div>
                `;

                alertOverlay.classList.add('visible');

                clearTimeout(alertTimeout);
                alertTimeout = setTimeout(() => {
                    alertOverlay.classList.remove('visible');
                }, duration);
            } else {
                // 使用错误提示样式
            const alertOverlay = document.getElementById('customAlertModalOverlay');
            const alertContent = document.getElementById('customAlertModalContent');
            
                alertContent.innerHTML = `
                    <div class="custom-alert-icon">
                        <span>!</span>
                    </div>
                    <div class="custom-alert-text">${message}</div>
                `;
                
            alertOverlay.classList.add('visible');

            clearTimeout(alertTimeout);
            alertTimeout = setTimeout(() => {
                alertOverlay.classList.remove('visible');
            }, duration);
        }
        }

        // 终止拣货按钮点击事件
        document.getElementById('terminateBtn').onclick = function() {
            // Calculate the total remaining quantity from the list
            const remainingToPickInList = pendingData.reduce((sum, item) => sum + item.num, 0);

            // 更新待拣数量显示
            document.getElementById('terminatePendingCount').textContent = remainingToPickInList;
            
            // 显示确认弹窗
            document.getElementById('terminateModalOverlay').classList.add('visible');
        };

        // 终止拣货取消按钮
        document.getElementById('terminateCancelBtn').onclick = function() {
            document.getElementById('terminateModalOverlay').classList.remove('visible');
        };

        // 终止拣货确认按钮
        document.getElementById('terminateConfirmBtn').onclick = function() {
            // 关闭确认弹窗
            document.getElementById('terminateModalOverlay').classList.remove('visible');
            
            // 清除sessionStorage中的缓存
            sessionStorage.removeItem(`confirmedCounts_${pickingCode}`);
            
            // 显示成功提示
            showCustomAlert('拣货终止', 'success');
            
            // 延迟返回列表页
            setTimeout(() => {
                window.location.href = 'warehouse_picking_list.html';
            }, 1500);
        };

        // 页面加载时初始化
        document.getElementById('pickingCode').textContent = detailData[pickingCode].pickingCode;
        document.getElementById('shippingCode').textContent = detailData[pickingCode].shippingCode;
        updateInfoArea();
        renderPendingList();
    </script>
</body>
</html> 